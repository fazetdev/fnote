// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// User model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password for fallback
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  notes     Note[]
  goals     Goal[]
  plans     DailyPlan[]
  thoughts  Thought[]
  learned   LearnedItem[]
  passkeys  Passkey[]  // Added for WebAuthn
  
  @@map("users")
}

// Passkey model for WebAuthn authentication
model Passkey {
  id              String   @id @default(cuid())
  credentialId    String   @unique
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  publicKey       String   // Base64 encoded public key
  counter         Int      @default(0)
  deviceType      String   // "platform" or "cross-platform"
  transports      String[] // ["usb", "nfc", "ble", "internal"]
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime @updatedAt
  
  @@map("passkeys")
  @@index([userId])
  @@index([credentialId])
}

// Note model (for Notebook)
model Note {
  id        String   @id @default(cuid())
  title     String
  content   String
  category  String   // ideas, growth, business, work, personal
  tags      String[] // Array of tags
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notes")
  @@index([userId])
  @@index([category])
}

// Goal model with hierarchy
model Goal {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   // yearly, quarterly, monthly, weekly
  targetDate  DateTime
  progress    Int      @default(0) // 0-100
  status      String   @default("not-started") // not-started, in-progress, completed
  periodLabel String?  // Q1, January, Week 1, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Hierarchy self-relation
  parentId    String?
  parent      Goal?    @relation("GoalHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Goal[]   @relation("GoalHierarchy")
  
  // User relation
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("goals")
  @@index([userId])
  @@index([type])
  @@index([parentId])
  @@index([status])
}

// Daily Plan model
model DailyPlan {
  id        String   @id @default(cuid())
  date      DateTime @unique // Date only (time part ignored)
  focus     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks     Task[]
  
  @@map("daily_plans")
  @@index([userId])
  @@index([date])
}

// Task model (for DailyPlan)
model Task {
  id        String   @id @default(cuid())
  text      String
  completed Boolean  @default(false)
  time      String   // Time string like "09:00"
  priority  String   @default("medium") // low, medium, high
  createdAt DateTime @default(now())
  
  // Relations
  planId    String
  plan      DailyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  @@map("tasks")
  @@index([planId])
  @@index([completed])
}

// Thought model
model Thought {
  id        String   @id @default(cuid())
  content   String
  type      String   // insight, pattern, idea, reflection, question, observation
  mood      String   // üòä, üòê, üòî, üò°, ü§î, üéØ, üí°
  tags      String[]
  date      DateTime // Date only
  createdAt DateTime @default(now())
  
  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("thoughts")
  @@index([userId])
  @@index([type])
  @@index([date])
}

// Learned Item model
model LearnedItem {
  id        String   @id @default(cuid())
  title     String
  content   String
  category  String   // technology, business, personal, skills, ideas, general
  tags      String[]
  date      DateTime // Date only
  createdAt DateTime @default(now())
  
  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("learned_items")
  @@index([userId])
  @@index([category])
  @@index([date])
}

// Sync tracking for offline-first
model SyncLog {
  id          String   @id @default(cuid())
  userId      String
  entityType  String   // note, goal, plan, thought, learned
  entityId    String
  operation   String   // create, update, delete
  localData   Json?    // The data that was synced
  syncedAt    DateTime @default(now())
  status      String   @default("pending") // pending, synced, failed
  
  @@map("sync_logs")
  @@index([userId])
  @@index([status])
  @@index([entityType, entityId])
}
